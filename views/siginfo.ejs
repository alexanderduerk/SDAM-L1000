<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>L1000</title>
  <link rel="stylesheet" href="/css/tablestyles.css" />
  <link rel="stylesheet" href="/css/style.css" />
  <script>
    function adjustOffset(amount) {
      // Get the hidden input field for searchArg
      const searchArgField = document.getElementById('searchArg');
      // Decode and parse the JSON string from the hidden field
      let searchArg;
      try {
        searchArg = JSON.parse(searchArgField.value);
        console.log(`searchArg: ${JSON.stringify(searchArg)}`);
      } catch (e) {
        console.error('Error parsing searchArg:', e);
        return;
      }
      // Update offset and limit values
      const currentOffset = parseInt(searchArg.offset, 10) || 0;
      const limit = parseInt(searchArg.limit, 10) || 10;
      // Adjust offset
      searchArg.offset = currentOffset + (amount * limit);
      searchArg.offset = Math.max(searchArg.offset, 0);
      searchArg.limit = limit;
      // Update the hidden input field with the new searchArg
      searchArgField.value = JSON.stringify(searchArg);
      // Submit the form
      document.getElementById('searchForm').submit();
    }
    function changeLimit(newLimit) {
      const searchArgField = document.getElementById('searchArg');
      const searchArg = JSON.parse(searchArgField.value);
      searchArg.limit = newLimit;
      console.log(JSON.stringify(searchArg.limit));
      searchArgField.value = JSON.stringify(searchArg);
      document.getElementById('searchForm').submit();
    }

    function changeOrder(order, column, formid) {
      const searchArgField = document.getElementById('searchArg');
      const searchArg = JSON.parse(searchArgField.value);
      searchArg.order = order;
      searchArg.orderfield = column;
      searchArgField.value = JSON.stringify(searchArg);
      document.getElementById('searchForm').submit();
    }

function addDescendant(operator, valueInputId, field, formId) {
  const value = document.getElementById(valueInputId).value;

  const searchArgField = document.getElementById('searchArg');
  let searchArg = JSON.parse(searchArgField.value);

  searchArg.descendants = searchArg.descendants || [];

  const originalSearch = {
    op: searchArg.op,
    val: searchArg.val,
    field: searchArg.field
  };

  searchArg.op = '';
  searchArg.val = '';
  searchArg.field = '';

  const newDescendant = {
    op: operator,
    val: value,
    field
  };

  searchArg.descendants.push(originalSearch, newDescendant);
  searchArg.op = 'AND';

  searchArgField.value = JSON.stringify(searchArg);

  document.getElementById('searchForm').submit();
}

function forwardLink(value, column_name, searchForm, searchArgID) {
  const searchArgField = document.getElementById(searchArgID);
  let searchArg = JSON.parse(searchArgField.value);
  searchArg.val = value;
  searchArg.field = column_name;
  searchArg.op = 'contains';
  searchArg.limit = '25';
  searchArg.offset = '0';
  searchArg.orderfield = column_name;
  searchArg.order = 'ASC';
  searchArg.descendants = [];
  console.log(JSON.stringify(searchArg));
  searchArgField.value = JSON.stringify(searchArg);
  document.getElementById(searchForm).submit();
}
  </script>
</head>
<body>
  <script src="/advancedSearch.js"></script>
  <nav class="navbar">
    <div class="container">
      <a href="#" class="logo">L1000</a>
      <ul class="nav-links">
        <li><a href="#">Home</a></li>
        <li><a href="#">About</a></li>
        <li><a href="#">Services</a></li>
        <li><a href="#">Contact</a></li>
      </ul>
      <div class="menu-toggle">
        <span class="bar"></span>
        <span class="bar"></span>
        <span class="bar"></span>
      </div>
    </div>
  </nav>

  <main>
    <% if (data && data.length > 0) { %>
      <table>
  <thead>
    <tr>
      <th>
        Signature Name
        <span class="tooltip">ⓘ
          <span class="tooltiptext">This is the name of the signature.</span>
        </span>
        <button type="button" onclick="changeOrder('ASC', 'sig_name', 'change_order_signaturename')">ASC</button>
        <button type="button" onclick="changeOrder('DESC', 'sig_name', 'change_order_signaturename')">DESC</button>
        <input type="text" id="descendants_value" name="descendants_value" value="">
        <button type="button" onclick="addDescendant('contains', 'descendants_value', 'sig_name', 'descendants')">Search</button>
      </th>
      <th>
        Compound
        <span class="tooltip">ⓘ
          <span class="tooltiptext">This is the name of the compound used.</span>
        </span>
      </th>
      <th>
        Gene Target
        <span class="tooltip">ⓘ
          <span class="tooltiptext">The gene that the compound targets.</span>
        </span>
      </th>
      <th>
        Cells
        <span class="tooltip">ⓘ
          <span class="tooltiptext">The cell types used in the experiment.</span>
        </span>
      </th>
      <th>
        Perturbation Dose
        <span class="tooltip">ⓘ
          <span class="tooltiptext">The dose of the compound applied.</span>
        </span>
      </th>
      <th>
        Perturbation Time
        <span class="tooltip">ⓘ
          <span class="tooltiptext">The duration for which the compound was applied.</span>
        </span>
      </th>
      <th>
        Modulated Genes
        <span class="tooltip">ⓘ
          <span class="tooltiptext">Genes that were modulated in response to the compound.</span>
        </span>
      </th>
      <th>
        Transcriptional Activity Score
        <span class="tooltip">ⓘ
          <span class="tooltiptext">Score representing transcriptional activity.</span>
        </span>
      </th>
      <th>
        Is High Quality Data
        <span class="tooltip">ⓘ
          <span class="tooltiptext">Indicates if the data is of high quality.</span>
        </span>
      </th>
      <th>
        Did Pass Quality Control
        <span class="tooltip">ⓘ
          <span class="tooltiptext">Indicates if the data passed quality control checks.</span>
        </span>
      </th>
    </tr>
  </thead>
  <tbody>
    <% for (const row of data) { %>
      <tr>
        <% for (const [key, value] of Object.entries(row)) { %>
          <td>
            <% if (key === 'cell_name') { %>
              <a href="#" onclick="forwardLink('<%= value %>', 'cell_name', 'searchFormCells', 'searchArgCells')"><%= value %></a>
            <% } else if (key === 'pert_name') { %>
              <a href="#" onclick="forwardLink('<%= value %>', 'pert_name', 'searchFormPerts', 'searchArgPerts')"><%= value %></a>
            <% } else if (key === 'gene_target') { %>
              <a href="#" onclick="forwardLink('<%= value %>', 'gene_symbol', 'searchFormGenes', 'searchArgGenes')"><%= value %></a>
            <% } else { %>
              <%= value %>
            <% } %>
          </td>
        <% } %>
      </tr>
    <% } %>
  </tbody>
</table>
<% } else { %>
  <p>No data available</p>
<% } %>
    <button type="button" onclick="adjustOffset(-1, event)">Prev.</button>
    <button type="button" onclick="adjustOffset(1, event)">Next.</button>
    <button type="button" onclick="changeLimit(25)">25</button>
    <button type="button" onclick="changeLimit(50)">50</button>
    <button type="button" onclick="changeLimit(100)">100</button>
    <form
      id="searchForm"
      action="/siginfo/search"
      method="post"
    >
      <input type="hidden" id="searchArg" name="searchArg" value="<%= JSON.stringify(siteSearchArg) %>">
    </form>
    <form id="searchFormCells" action="/cells/searchUI" method="post">
      <input type="hidden" id="searchArgCells" name="searchArg" value="<%= JSON.stringify(siteSearchArg) %>">
    </form>
    <form id="searchFormPerts" action="/perturbations/searchUI" method="post">
      <input type="hidden" id="searchArgPerts" name="searchArg" value="<%= JSON.stringify(siteSearchArg) %>">
    </form>
    <form id="searchFormGenes" action="/genes/searchUI" method="post">
      <input type="hidden" id="searchArgGenes" name="searchArg" value="<%= JSON.stringify(siteSearchArg) %>">
    </form>
  </main>
</body>
</html>
